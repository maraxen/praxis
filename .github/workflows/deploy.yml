name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install Python dependencies
        run: uv sync

      - name: Generate assets
        run: uv run --with pylibftdi scripts/generate_browser_db.py

      - name: Build JupyterLite REPL
        run: |
          uv run jupyter lite build --config praxis/web-client/jupyterlite-config.json --output-dir praxis/web-client/src/assets/jupyterlite
          git checkout praxis/web-client/src/assets/jupyterlite/jupyter-lite.gh-pages.json

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Node dependencies
        working-directory: ./praxis/web-client
        run: bun install

      - name: Build web client
        working-directory: ./praxis/web-client
        run: bun run build:gh-pages

      - name: Fix JupyterLite config for deployment
        working-directory: ./praxis/web-client
        run: |
          # build:gh-pages overwrites the build-generated jupyter-lite.json with a stale copy.
          # Restore the build-generated config (correct extension refs) and patch only baseUrl.
          sed 's|"baseUrl": "./"|"baseUrl": "/praxis/assets/jupyterlite/"|' \
            src/assets/jupyterlite/jupyter-lite.json > \
            dist/web-client/browser/assets/jupyterlite/jupyter-lite.json

      - name: SPA Fix (404.html + .nojekyll)
        run: |
          cp ./praxis/web-client/dist/web-client/browser/index.html ./praxis/web-client/dist/web-client/browser/404.html
          touch ./praxis/web-client/dist/web-client/browser/.nojekyll

      - name: Add COOP/COEP service worker
        run: |
          curl -sSL https://raw.githubusercontent.com/gzuidhof/coi-serviceworker/master/coi-serviceworker.js \
            -o ./praxis/web-client/dist/web-client/browser/coi-serviceworker.js

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./praxis/web-client/dist/web-client/browser

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
